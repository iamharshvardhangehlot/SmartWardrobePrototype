{% extends 'base.html' %}

{% block content %}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

<style>
    :root {
        --c-emerald: #328E6E;
        --c-leaf: #67AE6E;
        --c-lime: #90C67C;
        --c-cream: #E1EEBC;
        --c-dark: #050b08;
        --c-surface: rgba(11, 20, 16, 0.7);
        --c-line: rgba(225, 238, 188, 0.1);
    }

    body {
        font-family: 'Outfit', sans-serif;
        background-color: var(--c-dark);
        overflow-x: hidden;
    }

    .noise-overlay {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.07'/%3E%3C/svg%3E");
        opacity: 0.05;
        pointer-events: none;
        z-index: 1;
    }

    .blob {
        position: fixed;
        border-radius: 50%;
        filter: blur(90px);
        opacity: 0.55;
        z-index: 0;
        animation: float 22s infinite alternate cubic-bezier(0.4, 0, 0.2, 1);
        pointer-events: none;
    }
    .blob-1 { top: -12%; left: -18%; width: 520px; height: 520px; background: var(--c-emerald); }
    .blob-2 { bottom: -14%; right: -18%; width: 640px; height: 640px; background: var(--c-emerald); opacity: 0.35; animation-delay: -6s; }
    .blob-3 { top: 40%; left: 42%; width: 380px; height: 380px; background: var(--c-leaf); opacity: 0.28; animation-delay: -10s; }

    @keyframes float {
        0% { transform: translate(0, 0) scale(1); }
        100% { transform: translate(28px, 48px) scale(1.08); }
    }

    .glass {
        background: var(--c-surface);
        backdrop-filter: blur(18px);
        -webkit-backdrop-filter: blur(18px);
        border: 1px solid var(--c-line);
    }

    .pill {
        border-radius: 999px;
        border: 1px solid rgba(103, 174, 110, 0.4);
        color: var(--c-lime);
        font-size: 10px;
        letter-spacing: 0.28em;
        text-transform: uppercase;
        padding: 6px 12px;
    }

    .console {
        background: rgba(10, 18, 14, 0.88);
        border: 1px solid rgba(103, 174, 110, 0.25);
        border-radius: 26px;
        box-shadow: 0 18px 40px rgba(0, 0, 0, 0.35);
    }

    .slot {
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 20px;
        overflow: hidden;
    }

    .control-pill {
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 16px;
        padding: 8px 12px;
        color: #E1EEBC;
        font-size: 11px;
    }

    .btn-primary {
        background: var(--c-leaf);
        color: #07100c;
        border-radius: 16px;
        font-weight: 600;
    }

    .btn-ghost {
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 16px;
    }

    .scan-line {
        position: absolute;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, transparent, #90C67C, transparent);
        animation: scan 2.2s ease-in-out infinite;
    }

    @keyframes scan {
        0% { top: 12%; opacity: 0.1; }
        50% { top: 72%; opacity: 0.6; }
        100% { top: 12%; opacity: 0.1; }
    }
</style>

<div class="noise-overlay"></div>
<div class="blob blob-1"></div>
<div class="blob blob-2"></div>
<div class="blob blob-3"></div>

<div class="min-h-screen flex flex-col p-6 relative z-20 max-w-5xl mx-auto w-full">
    <div class="flex items-center justify-between mb-6">
        <div>
            <div class="text-xs uppercase tracking-[0.35em] text-[#90C67C]">Outfit Console</div>
            <div class="text-2xl font-semibold text-[#E1EEBC]">{{ mood }} Mode</div>
        </div>
        <a href="{% url 'home' %}" class="glass px-4 py-2 rounded-full text-xs uppercase tracking-[0.25em]">Back</a>
    </div>

    <div class="console p-6">
        <div class="flex flex-wrap items-center gap-3 mb-5">
            <div class="pill">AI + Manual</div>
            <div class="control-pill">Shuffle updates unfrozen slots</div>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div class="slot p-4">
                <div class="text-xs uppercase tracking-[0.2em] text-[#90C67C]">Top</div>
                {% if top %}
                    <img src="{{ top.image.url }}" class="h-40 w-full object-cover rounded-lg mt-3">
                    <div class="text-sm text-[#E1EEBC] mt-2">{{ top.name }}</div>
                {% else %}
                    <div class="h-40 w-full rounded-lg bg-gray-900 flex items-center justify-center text-xs text-gray-500 mt-3">No Top</div>
                {% endif %}
                <label class="flex items-center gap-2 mt-3 text-xs text-[#E1EEBC]/70">
                    <input id="freeze-top" type="checkbox" class="rounded" {% if freeze_top %}checked{% endif %}>
                    Freeze Top
                </label>
                <select id="custom-top" class="w-full bg-gray-900 text-white text-xs rounded-lg px-2 py-2 border border-gray-700 mt-3">
                    <option value="">Select Top</option>
                    {% for item in wardrobe_tops %}
                        <option value="{{ item.id }}">{{ item.name }} ({{ item.category }})</option>
                    {% endfor %}
                </select>
            </div>
            <div class="slot p-4">
                <div class="text-xs uppercase tracking-[0.2em] text-[#90C67C]">Bottom</div>
                {% if bottom %}
                    <img src="{{ bottom.image.url }}" class="h-40 w-full object-cover rounded-lg mt-3">
                    <div class="text-sm text-[#E1EEBC] mt-2">{{ bottom.name }}</div>
                {% else %}
                    <div class="h-40 w-full rounded-lg bg-gray-900 flex items-center justify-center text-xs text-gray-500 mt-3">No Bottom</div>
                {% endif %}
                <label class="flex items-center gap-2 mt-3 text-xs text-[#E1EEBC]/70">
                    <input id="freeze-bottom" type="checkbox" class="rounded" {% if freeze_bottom %}checked{% endif %}>
                    Freeze Bottom
                </label>
                <select id="custom-bottom" class="w-full bg-gray-900 text-white text-xs rounded-lg px-2 py-2 border border-gray-700 mt-3">
                    <option value="">Select Bottom</option>
                    {% for item in wardrobe_bottoms %}
                        <option value="{{ item.id }}">{{ item.name }} ({{ item.category }})</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <form method="get" class="grid grid-cols-2 gap-2 mt-4">
            <input type="hidden" name="mood" value="{{ mood }}">
            <input type="hidden" name="top_id" value="{{ top.id|default:'' }}">
            <input type="hidden" name="bottom_id" value="{{ bottom.id|default:'' }}">
            <input type="hidden" name="freeze_top" value="{% if freeze_top %}1{% endif %}">
            <input type="hidden" name="freeze_bottom" value="{% if freeze_bottom %}1{% endif %}">

            <select name="top_filter" class="bg-gray-900 text-white text-xs rounded-lg px-2 py-2 border border-gray-700">
                <option value="">Top Filter</option>
                {% for opt in filter_options %}
                    <option value="{{ opt }}" {% if opt in top_filters %}selected{% endif %}>{{ opt|capfirst }}</option>
                {% endfor %}
            </select>

            <select name="bottom_filter" class="bg-gray-900 text-white text-xs rounded-lg px-2 py-2 border border-gray-700">
                <option value="">Bottom Filter</option>
                {% for opt in filter_options %}
                    <option value="{{ opt }}" {% if opt in bottom_filters %}selected{% endif %}>{{ opt|capfirst }}</option>
                {% endfor %}
            </select>

            <button type="submit" class="btn-ghost py-2 text-xs text-white">Apply Filters</button>
            <button type="button" onclick="shuffleOutfit()" class="btn-primary py-2 text-xs">Shuffle</button>
        </form>

        <div class="grid grid-cols-3 gap-2 mt-4">
            <button onclick="startTryOnUnified()" class="btn-primary py-3 text-sm">Try On</button>
            <button id="save-btn" onclick="saveOutfit()" class="btn-ghost py-3 text-sm text-white">Save Look</button>
            <button id="schedule-btn" onclick="scheduleOutfit('ai')" class="btn-ghost py-3 text-sm text-white">Schedule</button>
        </div>

        <div class="mt-4 grid grid-cols-2 gap-3">
            <div>
                <label class="block text-[10px] text-[#E1EEBC]/60 uppercase tracking-widest mb-1">Schedule Date</label>
                <input id="schedule-date" type="date" min="{{ today_date|date:'Y-m-d' }}" class="w-full bg-gray-900 text-white text-sm rounded-lg px-3 py-2 border border-gray-700">
            </div>
            <div class="flex items-end">
                <button onclick="wearOutfit()" class="btn-primary py-3 w-full text-sm">Wear This</button>
            </div>
        </div>
    </div>

    <div class="relative w-full max-w-sm mx-auto mt-10 bg-black rounded-xl border border-gray-700 shadow-2xl overflow-hidden min-h-[380px] flex flex-col items-center justify-center">
        <img id="tryon-result" class="w-full h-full object-cover hidden">

        {% if profile.full_body_image %}
            <img id="tryon-placeholder" src="{{ profile.full_body_image.url }}" class="w-full h-full object-cover opacity-60">
        {% else %}
            <div class="text-gray-500 p-10">No full body photo uploaded</div>
        {% endif %}

        <div id="tryon-overlay" class="absolute inset-0 flex items-center justify-center">
            {% if profile.full_body_image %}
            <button id="visualize-btn" onclick="startTryOnUnified()" class="btn-primary py-3 px-8">Visualize</button>
            {% else %}
            <a href="{% url 'setup' %}" class="btn-ghost px-6 py-2 text-sm text-white">Upload Body Photo</a>
            {% endif %}
        </div>

        <div id="tryon-loader" class="absolute inset-0 bg-black/90 hidden flex-col items-center justify-center text-white z-20">
            <div class="scan-line"></div>
            <p class="font-bold text-[#90C67C]">AI is dressing you...</p>
            <p class="text-xs text-gray-500 mt-2">Generating realistic pixels (~30s)</p>
        </div>
    </div>
</div>

<script>
    let lastTryOn = null;

    function setTryOnState(imageUrl, topId, bottomId, source) {
        lastTryOn = { imageUrl, topId, bottomId, source };
    }

    function getUnifiedIds() {
        const topSelect = document.getElementById('custom-top');
        const bottomSelect = document.getElementById('custom-bottom');
        const topId = topSelect && topSelect.value ? topSelect.value : "{{ top.id|default:'' }}";
        const bottomId = bottomSelect && bottomSelect.value ? bottomSelect.value : "{{ bottom.id|default:'' }}";
        return { topId, bottomId };
    }

    function startTryOnUnified() {
        const ids = getUnifiedIds();
        startTryOnWithIds(ids.topId, ids.bottomId, "ai");
    }

    function startTryOnWithIds(topId, bottomId, source) {
        const overlay = document.getElementById('tryon-overlay');
        const loader = document.getElementById('tryon-loader');
        const resultImg = document.getElementById('tryon-result');
        const placeholder = document.getElementById('tryon-placeholder');

        overlay.classList.add('hidden');
        loader.classList.remove('hidden');

        const formData = new FormData();
        if (topId) formData.append('top_id', topId);
        if (bottomId) formData.append('bottom_id', bottomId);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        fetch("{% url 'try_on' %}", {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                resultImg.src = data.image_url;
                resultImg.classList.remove('hidden');
                if (placeholder) placeholder.classList.add('hidden');
                loader.classList.add('hidden');
                setTryOnState(data.image_url, topId, bottomId, source);
            } else {
                alert("AI Error: " + data.message);
                loader.classList.add('hidden');
                overlay.classList.remove('hidden');
            }
        })
        .catch(err => {
            console.error(err);
            alert("Network Error");
            loader.classList.add('hidden');
            overlay.classList.remove('hidden');
        });
    }

    function saveOutfit() {
        if (!lastTryOn || !lastTryOn.imageUrl) {
            alert("Please visualize an outfit first!");
            return;
        }

        const formData = new FormData();
        formData.append('image_url', lastTryOn.imageUrl);
        if (lastTryOn.topId) formData.append('top_id', lastTryOn.topId);
        if (lastTryOn.bottomId) formData.append('bottom_id', lastTryOn.bottomId);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        const btn = document.getElementById('save-btn');
        const originalText = btn.innerHTML;
        btn.innerHTML = "Saving...";
        btn.disabled = true;

        fetch("{% url 'save_outfit' %}", {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                btn.innerHTML = "Saved!";
                btn.classList.replace('btn-ghost', 'btn-primary');
                setTimeout(() => {
                    window.location.href = "{% url 'lookbook' %}";
                }, 1000);
            } else {
                alert("Error: " + data.message);
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        })
        .catch(err => {
            console.error(err);
            alert("Save Failed");
            btn.innerHTML = originalText;
            btn.disabled = false;
        });
    }

    function scheduleOutfit(source) {
        const dateInput = document.getElementById('schedule-date');
        const scheduledDate = dateInput ? dateInput.value : null;

        const ids = getUnifiedIds();
        const topId = ids.topId;
        const bottomId = ids.bottomId;

        if (!topId && !bottomId) {
            alert("Select a top or bottom first.");
            return;
        }

        const formData = new FormData();
        formData.append('scheduled_date', scheduledDate || '');
        if (topId) formData.append('top_id', topId);
        if (bottomId) formData.append('bottom_id', bottomId);
        formData.append('source', source);
        if (lastTryOn && lastTryOn.imageUrl) {
            formData.append('image_url', lastTryOn.imageUrl);
        }
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        const btn = document.getElementById('schedule-btn');
        if (btn) {
            btn.disabled = true;
            btn.innerHTML = "Scheduling...";
        }

        fetch("{% url 'schedule_outfit' %}", {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert(data.message);
            } else {
                alert("Error: " + data.message);
            }
        })
        .catch(err => {
            console.error(err);
            alert("Schedule Failed");
        })
        .finally(() => {
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = "Schedule";
            }
        });
    }

    function wearOutfit() {
        const ids = getUnifiedIds();
        const topId = ids.topId;
        const bottomId = ids.bottomId;

        if (!topId && !bottomId) {
            alert("No outfit to wear!");
            return;
        }

        if (!confirm("Confirm you are wearing this outfit? Points will be added!")) return;

        const formData = new FormData();
        if (topId) formData.append('top_id', topId);
        if (bottomId) formData.append('bottom_id', bottomId);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        fetch("{% url 'confirm_wear' %}", {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert(data.message);
                window.location.href = "{% url 'dashboard' %}";
            } else {
                alert("Error: " + data.message);
            }
        })
        .catch(err => console.error(err));
    }

    function shuffleOutfit() {
        const freezeTop = document.getElementById('freeze-top').checked;
        const freezeBottom = document.getElementById('freeze-bottom').checked;
        const topId = document.getElementById('custom-top').value || "{{ top.id|default:'' }}";
        const bottomId = document.getElementById('custom-bottom').value || "{{ bottom.id|default:'' }}";

        const url = new URL(window.location.href);
        url.searchParams.set('mood', "{{ mood }}");
        if (freezeTop) {
            url.searchParams.set('freeze_top', '1');
            if (topId) url.searchParams.set('top_id', topId);
        } else {
            url.searchParams.delete('freeze_top');
            url.searchParams.delete('top_id');
        }
        if (freezeBottom) {
            url.searchParams.set('freeze_bottom', '1');
            if (bottomId) url.searchParams.set('bottom_id', bottomId);
        } else {
            url.searchParams.delete('freeze_bottom');
            url.searchParams.delete('bottom_id');
        }
        window.location.href = url.toString();
    }
</script>
{% endblock %}
