{% extends 'base.html' %}

{% block content %}
<div class="max-w-2xl mx-auto bg-gray-800 p-8 rounded-xl shadow-2xl mt-10 relative">
    
    <a href="{% url 'home' %}" class="absolute top-4 right-4 text-gray-400 hover:text-white text-xl">‚úï</a>

    <h1 class="text-3xl font-bold text-white mb-2">Style Profile</h1>
    <p class="text-gray-400 mb-8">We need two photos: one for Color Analysis, one for Virtual Try-On.</p>

    <form method="post" enctype="multipart/form-data" class="space-y-6">
        {% csrf_token %}
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
                <label class="block text-gray-300 mb-2">City</label>
                {{ form.city }}
            </div>
            <div>
                <label class="block text-gray-300 mb-2">Timezone</label>
                {{ form.timezone }}
                <p class="text-[10px] text-gray-400 mt-1">Auto-detected on load. You can edit.</p>
            </div>
        </div>

<div class="grid grid-cols-2 gap-4">
            <div>
                <label class="block text-gray-300 mb-2">Height (cm)</label>
                {{ form.height_cm }}
            </div>
            <div>
                <label class="block text-gray-300 mb-2">Weight (kg)</label>
                {{ form.weight_kg }}
            </div>
        </div>

        <div class="bg-gray-700 p-4 rounded-lg">
            <label class="block text-blue-300 font-bold mb-3">Check the veins on your wrist:</label>
            <div class="text-white space-y-2">
                {{ form.skin_undertone }}
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

            <label for="id_selfie" class="block border-2 border-dashed border-gray-600 hover:border-blue-500 p-4 rounded-lg text-center cursor-pointer transition relative group h-full flex flex-col justify-center">
                
                {% if form.instance.selfie %}
                    <div class="mb-2">
                        <img src="{{ form.instance.selfie.url }}" class="w-20 h-20 rounded-full mx-auto object-cover border-2 border-green-500">
                        <p class="text-[10px] text-green-400 font-bold mt-1">‚úÖ Face Saved</p>
                        <div class="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition rounded-lg">
                            <span class="text-white text-xs font-bold">Change</span>
                        </div>
                    </div>
                {% else %}
                    <span class="text-3xl block mb-2">üë©</span>
                {% endif %}

                <span class="block text-white text-sm font-bold">
                    {% if form.instance.selfie %} Change Selfie {% else %} Upload Selfie {% endif %}
                </span>
                <p class="text-[10px] text-gray-400 mt-1">Face close-up, natural light.</p>
                
                {{ form.selfie }}
            </label>

            <label for="id_full_body_image" class="block border-2 border-dashed border-gray-600 hover:border-purple-500 p-4 rounded-lg text-center cursor-pointer transition relative group h-full flex flex-col justify-center">
                
                {% if form.instance.full_body_image %}
                    <div class="mb-2">
                        <img src="{{ form.instance.full_body_image.url }}" class="w-20 h-32 rounded mx-auto object-cover border-2 border-green-500">
                        <p class="text-[10px] text-green-400 font-bold mt-1">‚úÖ Body Saved</p>
                        <div class="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition rounded-lg">
                            <span class="text-white text-xs font-bold">Change</span>
                        </div>
                    </div>
                {% else %}
                    <span class="text-3xl block mb-2">üßç</span>
                {% endif %}

                <span class="block text-white text-sm font-bold">
                    {% if form.instance.full_body_image %} Change Body Photo {% else %} Full Body Photo {% endif %}
                </span>
                <p class="text-[10px] text-gray-400 mt-1">Standing straight, hands visible.</p>
                
                {{ form.full_body_image }}
            </label>
        </div>

        <div class="bg-gray-900/70 p-4 rounded-lg border border-purple-500/30">
            <div class="flex items-center justify-between gap-4">
                <div>
                    <h3 class="text-purple-300 font-bold text-sm mb-2">Full Body Photo Tips</h3>
                    <ul class="text-[11px] text-gray-300 space-y-1">
                        <li>Wear tight-fitted clothes for better accuracy.</li>
                        <li>Full body visible (head to toe), standing straight.</li>
                        <li>Neutral background with good lighting.</li>
                        <li>Keep arms slightly away from body.</li>
                    </ul>
                </div>
                <div class="w-24 h-32 bg-black/40 rounded-lg flex items-center justify-center border border-purple-500/30">
                    <svg viewBox="0 0 120 180" class="w-16 h-24 text-purple-300/70" fill="currentColor" aria-hidden="true">
                        <circle cx="60" cy="28" r="18"></circle>
                        <rect x="42" y="48" width="36" height="60" rx="12"></rect>
                        <rect x="26" y="68" width="18" height="50" rx="8"></rect>
                        <rect x="76" y="68" width="18" height="50" rx="8"></rect>
                        <rect x="44" y="108" width="16" height="56" rx="8"></rect>
                        <rect x="60" y="108" width="16" height="56" rx="8"></rect>
                    </svg>
                </div>
            </div>
        </div>

        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg transition">
            Save & Analyze
        </button>

        {% if form.instance.season %}
        <div class="mt-8 bg-black p-4 rounded-lg font-mono text-xs text-green-400 border border-green-900">
            <p class="uppercase font-bold text-white mb-2">/// AI DIAGNOSTICS ///</p>
            <div class="grid grid-cols-2 gap-2">
                <span>SEASON:</span> <span class="text-white">{{ form.instance.season }}</span>
                <span>UNDERTONE:</span> <span class="text-white">{{ form.instance.skin_undertone }}</span>
                <span>CONTRAST:</span> <span class="text-white">{{ form.instance.contrast_level }}</span>
            </div>
            
            <p class="mt-2 text-gray-500">
                *Detailed Saturation/Value logs are visible in the VS Code Terminal.
            </p>
        </div>
        {% endif %}
    </form>
</div>
{% endblock %}

<script>
(function() {
  const tzField = document.getElementById('id_timezone');
  if (tzField && !tzField.value) {
    try {
      tzField.value = Intl.DateTimeFormat().resolvedOptions().timeZone || '';
    } catch (e) {}
  }

  const cityField = document.getElementById('id_city');
  if (cityField && !cityField.value && navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        fetch(`/resolve-location/?lat=${lat}&lon=${lon}`)
          .then((res) => res.json())
          .then((data) => {
            if (data.status === 'success' && data.city && !cityField.value) {
              cityField.value = data.city;
            }
          })
          .catch(() => {});
      },
      () => {},
      { timeout: 4000 }
    );
  }
})();
</script>
